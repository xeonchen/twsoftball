# TW Softball - Codecov Configuration
# Optimized for hexagonal architecture monorepo with event sourcing

coverage:
  precision: 2
  round: down
  range: 80...100

  # Coverage status checks for PR and project
  status:
    project:
      # Overall project coverage target
      default:
        target: 92%
        threshold: 2%
        if_not_found: success
        if_ci_failed: error
        informational: false

      # Domain layer - Core business logic (highest standards)
      domain:
        target: 98%
        threshold: 1%
        flags: [domain]
        if_not_found: success
        if_ci_failed: error
        informational: false

      # Application layer - Use cases and ports
      application:
        target: 95%
        threshold: 2%
        flags: [application]
        if_not_found: success
        if_ci_failed: error
        informational: false

      # Infrastructure layer - Adapters and implementations
      infrastructure:
        target: 90%
        threshold: 3%
        flags: [infrastructure]
        if_not_found: success
        if_ci_failed: error
        informational: true # not implemented yet

      # Shared utilities
      shared:
        target: 92%
        threshold: 3%
        flags: [shared]
        if_not_found: success
        if_ci_failed: error
        informational: true # not implemented yet

      # Web app - PWA
      web:
        target: 92%
        threshold: 3%
        flags: [web]
        if_not_found: success
        if_ci_failed: error
        informational: true # not implemented yet

    # Patch coverage (for new code in PRs)
    patch:
      default:
        target: 95%
        threshold: 2%
        if_not_found: success
        if_ci_failed: error

      # Domain patches - Highest standards for new code
      domain:
        target: 98%
        threshold: 1%
        flags: [domain]
        if_not_found: success
        if_ci_failed: error

      # Application patches
      application:
        target: 95%
        threshold: 2%
        flags: [application]
        if_not_found: success
        if_ci_failed: error

      # Infrastructure patches
      infrastructure:
        target: 90%
        threshold: 3%
        flags: [infrastructure]
        if_not_found: success
        if_ci_failed: error
        informational: true # not implemented yet

      # Shared patches
      shared:
        target: 92%
        threshold: 3%
        flags: [shared]
        if_not_found: success
        if_ci_failed: error
        informational: true # not implemented yet

      # Web patches
      web:
        target: 92%
        threshold: 3%
        flags: [web]
        if_not_found: success
        if_ci_failed: error
        informational: true # not implemented yet

# Flag definitions for different parts of the monorepo
flags:
  # Merged coverage from all packages
  merged:
    paths:
      - '.'
    carryforward: false

  # Domain layer - Core business logic
  domain:
    paths:
      - packages/domain/src/
    carryforward: false

  # Application layer - Use cases and ports
  application:
    paths:
      - packages/application/src/
    carryforward: false

  # Infrastructure layer - Adapters and implementations
  infrastructure:
    paths:
      - packages/infrastructure/src/
    carryforward: true # Allow carryforward for slower-changing adapters

  # Shared utilities
  shared:
    paths:
      - packages/shared/src/
    carryforward: false

  # Web application
  web:
    paths:
      - apps/web/src/
    carryforward: true # Allow carryforward for UI components

# Component grouping for better visualization
component_management:
  default_rules:
    flag_regexes:
      - domain
      - application
      - infrastructure
      - shared
      - web
  individual_components:
    - component_id: domain
      name: 'Domain Layer'
      flag_regexes:
        - domain
    - component_id: application
      name: 'Application Layer'
      flag_regexes:
        - application
    - component_id: infrastructure
      name: 'Infrastructure Layer'
      flag_regexes:
        - infrastructure
    - component_id: shared
      name: 'Shared Utilities'
      flag_regexes:
        - shared
    - component_id: web
      name: 'Web Application'
      flag_regexes:
        - web

# PR comment configuration
comment:
  layout: 'reach, diff, flags, files, footer'
  behavior: default
  require_changes: false
  require_base: no
  require_head: yes
  show_carryforward_flags: true
  hide_project_coverage: false

# GitHub integration
github_checks:
  annotations: true

# Files to ignore from coverage
ignore:
  # Test files
  - '**/*.test.ts'
  - '**/*.spec.ts'
  - '**/test/**'
  - '**/tests/**'
  - '**/__tests__/**'
  - '**/*.test.tsx'
  - '**/*.spec.tsx'

  # Build and config files
  - '**/coverage/**'
  - '**/node_modules/**'
  - '**/dist/**'
  - '**/build/**'
  - '**/*.d.ts'

  # Configuration files
  - '**/vite.config.ts'
  - '**/vitest.config.ts'
  - '**/*.config.js'
  - '**/*.config.ts'
  - '**/tsconfig*.json'
  - '**/package.json'
  - '**/pnpm-lock.yaml'

  # Tools and scripts
  - 'tools/**'
  - 'scripts/**'
  - '.github/**'
  - 'docs/**'

  # Development files
  - '**/*.stories.ts'
  - '**/*.stories.tsx'
  - '**/.storybook/**'

# Path fixes for monorepo structure
fixes:
  # Fix paths for domain package
  - 'packages/domain/dist/:packages/domain/src/'
  - 'packages/domain/coverage/:packages/domain/src/'

  # Fix paths for application package
  - 'packages/application/dist/:packages/application/src/'
  - 'packages/application/coverage/:packages/application/src/'

  # Fix paths for infrastructure package
  - 'packages/infrastructure/dist/:packages/infrastructure/src/'
  - 'packages/infrastructure/coverage/:packages/infrastructure/src/'

  # Fix paths for shared package
  - 'packages/shared/dist/:packages/shared/src/'
  - 'packages/shared/coverage/:packages/shared/src/'

  # Fix paths for web app
  - 'apps/web/dist/:apps/web/src/'
  - 'apps/web/coverage/:apps/web/src/'
